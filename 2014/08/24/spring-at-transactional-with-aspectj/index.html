
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Spring @Transactional With AspectJ - Groovy Adventures</title>
  <meta name="author" content="sevenlist">

  
  <meta name="description" content="Spring @Transactional with AspectJ - For private methods use @EnableTransactionManagement(mode = AdviceMode.ASPECTJ) and aspectj-maven-plugin.">
  <meta name="keywords" content="spring @transactional with aspectj, no sources found skipping aspectj compile, aspectj-maven-plugin, @transactional, aspectj">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://sevenlist.github.io/2014/08/24/spring-at-transactional-with-aspectj">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Groovy Adventures" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53911430-1', 'auto');
    ga('send', 'pageview');

</script>

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Groovy Adventures</a></h1>
  
    <h2>A developer's journey.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:sevenlist.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Spring @Transactional With AspectJ</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-08-24T12:05:00+02:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>12:05 pm</span></time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://sevenlist.github.io">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>If we want to use the <code>@Transactional</code> annotation on private methods, we cannot use Spring&rsquo;s default proxy mode -
it only works for public methods that are called from client code.</p>

<p>For self-invoked methods we need to use <em>AspectJ</em>.</p>

<!--more-->


<h3>An Example</h3>

<p>This may be the case e.g. when we want to save incoming data and send a letter using that data within a transaction.
If saving the data fails we do not want to send the letter.
If sending the letter fails we do not want to loose the data that we received.
Hence, we want to save the data in a separate transaction, by annotating our saveData(..) method with
<code>@Transactional(propagation = Propagation.REQUIRES_NEW)</code>.</p>

<h3>Configuring Spring To Use AspectJ</h3>

<p>On a <code>@Configuration</code> class we just need to set the AspectJ advice mode for the transaction management configuration:</p>

<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="nd">@Configuration</span>
</span><span class='line'><span class="nd">@ComponentScan</span>
</span><span class='line'><span class="nd">@EnableTransactionManagement</span><span class="o">(</span><span class="n">mode</span> <span class="o">=</span> <span class="n">AdviceMode</span><span class="o">.</span><span class="na">ASPECTJ</span><span class="o">)</span>
</span><span class='line'><span class="kd">class</span> <span class="nc">ApplicationConfiguration</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>


<h3>Configuring Maven To Run The AspectJ Compiler</h3>

<p>Next we need to use the AspectJ compiler, so let&rsquo;s add its needed dependencies:</p>

<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;dependencies&gt;</span>
</span><span class='line'>    <span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>        <span class="nt">&lt;groupId&gt;</span>org.aspectj<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;artifactId&gt;</span>aspectjrt<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;version&gt;</span>1.7.4<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">&lt;!-- In this example we use JPA for persistence. --&gt;</span>
</span><span class='line'>    <span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>        <span class="nt">&lt;groupId&gt;</span>org.hibernate.javax.persistence<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;artifactId&gt;</span>hibernate-jpa-2.1-api<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;version&gt;</span>1.0.0.Final<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>        <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;artifactId&gt;</span>spring-aspects<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;version&gt;</span>4.0.6.RELEASE<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependencies&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>The AspectJ compiler itself can then be enabled with:</p>

<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;build&gt;</span>
</span><span class='line'>    <span class="nt">&lt;plugins&gt;</span>
</span><span class='line'>        <span class="nt">&lt;plugin&gt;</span>
</span><span class='line'>            <span class="nt">&lt;groupId&gt;</span>org.codehaus.mojo<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>            <span class="nt">&lt;artifactId&gt;</span>aspectj-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>            <span class="nt">&lt;version&gt;</span>1.6<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>            <span class="nt">&lt;executions&gt;</span>
</span><span class='line'>                <span class="nt">&lt;execution&gt;</span>
</span><span class='line'>                    <span class="nt">&lt;goals&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;goal&gt;</span>compile<span class="nt">&lt;/goal&gt;</span>
</span><span class='line'>                        <span class="c">&lt;!-- &lt;goal&gt;test-compile&lt;/goal&gt; --&gt;</span>
</span><span class='line'>                    <span class="nt">&lt;/goals&gt;</span>
</span><span class='line'>                <span class="nt">&lt;/execution&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/executions&gt;</span>
</span><span class='line'>            <span class="nt">&lt;configuration&gt;</span>
</span><span class='line'>                <span class="nt">&lt;complianceLevel&gt;</span>1.7<span class="nt">&lt;/complianceLevel&gt;</span>
</span><span class='line'>                <span class="nt">&lt;forceAjcCompile&gt;</span>true<span class="nt">&lt;/forceAjcCompile&gt;</span>
</span><span class='line'>                <span class="nt">&lt;weaveDirectories&gt;</span>
</span><span class='line'>                    <span class="nt">&lt;weaveDirectory&gt;</span>${project.build.outputDirectory}<span class="nt">&lt;/weaveDirectory&gt;</span>
</span><span class='line'>                <span class="nt">&lt;/weaveDirectories&gt;</span>
</span><span class='line'>                <span class="nt">&lt;aspectLibraries&gt;</span>
</span><span class='line'>                    <span class="nt">&lt;aspectLibrary&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;artifactId&gt;</span>spring-aspects<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>                    <span class="nt">&lt;/aspectLibrary&gt;</span>
</span><span class='line'>                <span class="nt">&lt;/aspectLibraries&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/configuration&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/plugin&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/plugin&gt;</span>
</span><span class='line'><span class="nt">&lt;/build&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>If we do not use <code>&lt;forceAjcCompile&gt;</code> and do not set the <code>&lt;weaveDirectory&gt;</code> AspectJ will not weave the transaction code into
our generated Groovy bytecode. Instead, it will warn us with <em>No sources found skipping aspectJ compile</em> when Maven runs.
That is as the aspectj-maven-plugin processes the src/main/java directory by default but not src/main/groovy.</p>

<h3>How The AspectJ Generated Code Looks Like</h3>

<p>Just for completeness, let&rsquo;s look how AspectJ has wrapped the saveData(..) method with a transaction. Using the
<a href="https://bitbucket.org/mstrobel/procyon/wiki/Java%20Decompiler">Procyon</a> decompiler we can see:</p>

<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span> <span class="o">=</span> <span class="n">Propagation</span><span class="o">.</span><span class="na">REQUIRES_NEW</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">saveData</span><span class="o">(</span><span class="kd">final</span> <span class="n">SomeData</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">((</span><span class="n">AbstractTransactionAspect</span><span class="o">)</span><span class="n">AnnotationTransactionAspect</span><span class="o">.</span><span class="na">aspectOf</span><span class="o">()).</span><span class="na">ajc</span><span class="n">$around$org_springframework_transaction_aspectj_AbstractTransactionAspect$1$2a73e96c</span><span class="o">((</span><span class="n">Object</span><span class="o">)</span><span class="k">this</span><span class="o">,</span> <span class="o">(</span><span class="n">AroundClosure</span><span class="o">)</span><span class="k">new</span> <span class="n">DataService$AjcClosure3</span><span class="o">(</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]</span> <span class="o">{</span> <span class="k">this</span><span class="o">,</span> <span class="n">data</span> <span class="o">}),</span> <span class="n">DataService</span><span class="o">.</span><span class="na">ajc</span><span class="n">$tjp_1</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">sevenlist</span></span>

      




<time class='entry-date' datetime='2014-08-24T12:05:00+02:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>12:05 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/categories/at-transactional/'>@transactional</a>, <a class='category' href='/categories/aspectj/'>aspectj</a>, <a class='category' href='/categories/spring/'>spring</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://sevenlist.github.io/2014/08/24/spring-at-transactional-with-aspectj/" data-via="" data-counturl="http://sevenlist.github.io/2014/08/24/spring-at-transactional-with-aspectj/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
      
        <a class="basic-alignment right" href="/2014/08/24/anonymous-class-field-initialized-with-an-enclosing-argument-results-in-missingpropertyexception/" title="Next Post: Anonymous class field initialized with an enclosing argument results in MissingPropertyException">Anonymous class field initialized with an enclosing argument results in MissingPropertyException &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2014/08/24/a-groovy-java-puzzler-setting-a-property-when-its-setter-is-overloaded/">A Groovy Java Puzzler: Setting a Property When Its Setter Is Overloaded</a>
      </li>
    
      <li class="post">
        <a href="/2014/08/24/anonymous-class-field-initialized-with-an-enclosing-argument-results-in-missingpropertyexception/">Anonymous Class Field Initialized With an Enclosing Argument Results in MissingPropertyException</a>
      </li>
    
      <li class="post">
        <a href="/2014/08/24/spring-at-transactional-with-aspectj/">Spring @Transactional With AspectJ</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - sevenlist -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'sevenlist';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://sevenlist.github.io/2014/08/24/spring-at-transactional-with-aspectj/';
        var disqus_url = 'http://sevenlist.github.io/2014/08/24/spring-at-transactional-with-aspectj/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
